{% extends "layout.html" %}

{% block title %}Broadcast Lists{% endblock %}
{% block navlink3 %}active{% endblock %}

{% block main %}

<div class="alert-placeholder">
    <div class="alert alert-success">asdf</div>
</div>

<div class="mx-auto d-flex flex-column align-items-center py-5 opacity-50">
    <p class="fs-2 pb-1 border-bottom-primary" >Broadcast Lists</p>
    <p class="mt-2 text-center">Note: These lists will make it easier and faster for you to share your events with certain groups of people.
        <br>Note: You can only add users that have created an account on this platform.</p>
</div>

<div class="d-flex flex-wrap gap-4 align-items-start" id="cards-container"></div>
<button class="btn btn-light" id="new-list-btn">Create New List</button>
<div class="modal fade bg-dark" id="lists-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">

      <div class="modal-content bg-primary">

        <div class="modal-header p-4" style="border: none;">
          <button type="button" class="btn-close" style="filter: invert(1);" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body p-4 d-flex flex-column gap-5">

          <input class="form-control" type="text" name="list-name" id="list-name-inpt" placeholder="Broadcast List Name">
          
          <div class="d-flex gap-2">
            <input class="form-control" type="email" name="user-email" id="user-email-inpt" placeholder="person@gmail.com">
            <button class="btn btn-sm btn-light" style="width: 30%;" id="add-new-user">Add User</button>
          </div>

          <div class="d-flex flex-column gap-2" id="user-rows-container">
            
            

          </div>
        </div>

        <div class="modal-footer p-4" >
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="create-list-confirm">Create List</button>
        </div>
      </div>

    </div>
</div>
{% endblock %}

{% block script %}
<script>
    
    // Modal
    const rowsContainer = document.getElementById('user-rows-container')
    const listsModal = new bootstrap.Modal('#lists-modal', {
        keyboard: true,
        focus: true,
        backdrop: false
    })
    let usersList = []


    //////////// Create New List Button (btn on page)
    const newListBtn = document.getElementById('new-list-btn')
    newListBtn.addEventListener('click', handleNewListBtnClick)

    function handleNewListBtnClick(e) {
        listsModal.show()
    }


    
    //////////// Add New User Button
    const emailInpt = document.getElementById('user-email-inpt')
    const addNewUserBtn = document.getElementById('add-new-user')
    addNewUserBtn.addEventListener('click', handleAddNewUserBtnClick)
    
    function handleAddNewUserBtnClick(e) {
        let isValid = true

        if (!emailInpt.value) {
            console.log('no email provided')
            return
        }

        if (!isValidEmail(emailInpt.value)){
            console.log('email is invalid')
            return
        }

        if (emailAlreadyInList(emailInpt.value, usersList)) {
            emailInpt.value = ''
            console.log('user already in list')
            return
        }
        

        fetch('/api/user-exists', {
            method: 'post',
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify( {email: emailInpt.value} )
        })
        .then(res => {
            if (!res.ok) throw new Error("Network response was not okay")
            return res.json()
        })
        .then(data => {
            // if user is found and isn't already in the list
            if ('email' in data){
                if (!emailAlreadyInList(data.email, usersList)){
                    // create row
                    rowsContainer.appendChild(createRow(data))
                    rowsContainer.appendChild(createSpacer(data.id))
                    // add user to list
                    usersList.push(data)
                }
                else {
                    console.log('user already in list')
                }
            }
            // if user not found
            else {
                console.log('user not found')
            }
            emailInpt.value = ''
        })
        .catch(err => console.log(err))
    }



    //////////// Remove User Row Icon
    function handleCloseIconClick(e) {
        let icon = e.target
        let row = icon.parentElement
        let rowId = Number(row.getAttribute('id').split('-')[1])

        // remove event listeneres
        e.target.removeEventListener('click', handleCloseIconClick)

        // remove user from list
        usersList = usersList.filter(user => user.id != rowId)

        // remove row and its spacer
        row.parentElement.querySelector(`#spacer-${rowId}`)?.remove()
        row.remove()
    }



    //////////// Confirm Create New List Btn (button on modal)
    const confirmNewListBtn = document.getElementById('create-list-confirm')
    confirmNewListBtn.addEventListener('click', handleConfirmNewListClick)
    const listNameInpt = document.getElementById('list-name-inpt')

    function handleConfirmNewListClick(e) {
        if (!listNameInpt.value) {
            console.log('please provide a list name')
            return
        }

        if (usersList.length == 0) {
            console.log('Add at least 1 user to the list')
            return
        }

        fetch('/api/new-broadcast-list', {
            method: 'post',
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                listName: listNameInpt.value,
                usersList: usersList
            })
        })
        .then(res => {
            if (!res.ok) throw new Error('Network response was not okay')
            return res.json()
        })
        .then(data => {
            if (data.success) {
                emailInpt.value = ''
                listNameInpt.value = ''
                rowsContainer.innerHTML = ''
                listsModal.hide()
                alert('new list created')
            }
            else {
                alert(data.message)
            }
        })
        .catch(err => console.log(err))
    }


    ////////// Helper Functions
    function isValidEmail(email) {
        const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return regex.test(email);
    }

    function emailAlreadyInList(email, list){
        for (let i = 0; i < list.length; i++){
            if (list[i].email == email) {
                return true
            }
        }
        return false
    }




    /////////// Modal Rendering Functions
    function createRow(user) {
        let row = document.createElement('div')
        row.classList = ['usr-row d-flex justify-content-between align-items-center']
        row.setAttribute('id', `row-${user.id}`)

        let contentWrapper = document.createElement('div')
        contentWrapper.classList = ['row-content']

        let userName = document.createElement('p')
        userName.classList = ['name']
        userName.textContent = user.name

        let userEmail = document.createElement('p')
        userEmail.classList = ['email']
        userEmail.textContent = user.email

        contentWrapper.appendChild(userName)
        contentWrapper.appendChild(userEmail)

        row.appendChild(contentWrapper)

        let closeIcon = document.createElement('img')
        closeIcon.setAttribute('src', './static/assets/close.svg')
        closeIcon.classList = ['close-icon']
        closeIcon.addEventListener('click', handleCloseIconClick)

        row.appendChild(closeIcon)

        return row
    }

    function createSpacer(id){
        let spacer = document.createElement('div')
        spacer.classList.add('spacer')
        spacer.setAttribute('id', `spacer-${id}`)
        return spacer
    }

</script>

<script>
    // Page Cards Rendering
    let data = [
        {
            id: 1,
            title: 'Family'
        },
        {
            id: 2,
            title: 'School Friends'
        },
        {
            id: 3,
            title: 'Work Friends'
        },
        {
            id: 4,
            title: 'Marketing Team'
        },
        {
            id: 5,
            title: 'University Final Project Team'
        },
    ]
    const cardsContainer = document.getElementById('cards-container')
    function renderCards(data) {
        data.forEach(card => {
            let c = createCard(card)
            cardsContainer.appendChild(c)
        })
    }
    function createCard({id, title: listTitle}){

        // Card
        let card = document.createElement('div')
        card.classList = ['card card-lists bg-secondary border-primary text-light']
        
        // Card Body
        let cBody = document.createElement('div')
        cBody.classList = ['card-body text-light pb-3 pt-3']
        
        let title = document.createElement('h4')
        title.classList = ['card-title m-0']
        title.textContent = listTitle
        cBody.appendChild(title)
        
        
        //Card Footer
        let footer = document.createElement('div')
        footer.classList = ['card-footer d-flex justify-content-between text-dark pt-0 pb-3']
        
        
        let editBtn = document.createElement('a')
        editBtn.classList = ['btn btn-light btn-sm']
        editBtn.textContent = 'Edit'
        footer.appendChild(editBtn)
        
        let deleteBtn = document.createElement('a')
        deleteBtn.classList = ['btn btn-secondary btn-sm']
        deleteBtn.textContent = 'Delete'
        footer.appendChild(deleteBtn)


        card.appendChild(cBody)
        card.appendChild(footer)

        return card
    }
    renderCards(data)

</script>
{% endblock %}
